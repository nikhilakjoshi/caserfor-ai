# PRD: AI Provider Switch + TipTap Editor Integration

## Overview

Switch from Anthropic Claude to Google Gemini for all AI agents and implement a split-panel document editing UX in the assistant.

---

## Current State

### AI Provider
- **SDK:** `@ai-sdk/anthropic` via Vercel AI SDK
- **Models:** `claude-sonnet-4-20250514` (default + analysis)
- **Config:** `lib/ai.ts` - singleton provider pattern
- **Endpoints using AI:**
  - `/api/assistant/query/route.ts` - main chat/document generation
  - `/api/assistant/improve/route.ts` - prompt refinement
  - `/api/test-ai/route.ts` - test endpoint

### Assistant UI
- Single-panel layout with plain text output
- Output types: `draft`, `review_table`, `chat`
- No rich text editor installed
- Uses `@ai-sdk/react` `useCompletion` hook for streaming
- File: `app/(dashboard)/assistant/page.tsx` (1550 lines)

### Frontend Stack
- React 19.2.3 + Next.js 16
- Tailwind CSS v4 + shadcn/ui
- Radix UI primitives
- No existing rich text editor

---

## Requirements (Finalized)

### 1. AI Provider Migration: Anthropic -> Gemini

**Models:**
- `gemini-2.5-flash` - default model
- `gemini-2.5-pro` - deep analysis mode

**Scope:**
- Replace `@ai-sdk/anthropic` with `@ai-sdk/google`
- Update `lib/ai.ts` to use `createGoogleGenerativeAI`
- Update env var: `ANTHROPIC_API_KEY` -> `GOOGLE_GENERATIVE_AI_API_KEY`
- All 3 API endpoints continue working with new provider

### 2. TipTap Editor Integration

**Mode Detection:** AI classification (agent auto-detects intent)

**Layout Change (Assistant Page):**
- **Chat mode:** Full-width chat interface (current behavior)
- **Document mode:** Split panel
  - Left 1/3: Chat interface
  - Right 2/3: TipTap editor

**Agent Routing Logic:**
- Agent analyzes incoming query
- Returns `mode: "chat" | "document"` in response
- UI switches layout based on mode
- Document content streams into TipTap editor

### 3. Document Features

**Persistence:** Auto-save to database
**Editor:** TipTap Simple Editor template (MIT licensed)

**Features included:**
- Responsive, mobile-friendly with dark/light mode
- Text formatting (bold, italic, underline)
- Lists (bullet, ordered, checkboxes)
- Text alignment + multiple heading levels
- Image upload + link editing
- Undo/redo

**Installation:** `npx @tiptap/cli@latest add simple-editor`

---

## Database Schema Addition

```prisma
model Document {
  id           String   @id @default(cuid())
  title        String?
  content      Json     // TipTap JSON format
  queryId      String?  @unique
  query        AssistantQuery? @relation(fields: [queryId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}
```

---

## Files to Modify

| File | Change |
|------|--------|
| `lib/ai.ts` | Switch provider to Google Gemini |
| `.env.example` | Update API key variable |
| `package.json` | Replace `@ai-sdk/anthropic` with `@ai-sdk/google`, add tiptap |
| `prisma/schema.prisma` | Add Document model |
| `app/api/assistant/query/route.ts` | Add mode detection, update model |
| `app/api/assistant/improve/route.ts` | Update model reference |
| `app/api/test-ai/route.ts` | Update model reference |
| `app/api/documents/route.ts` | New - document CRUD API |
| `app/(dashboard)/assistant/page.tsx` | Add split-panel layout, integrate editor |
| `components/editor/` | New - editor components |

---

## Implementation Plan

### Phase 1: AI Provider Switch
1. `npm install @ai-sdk/google && npm uninstall @ai-sdk/anthropic`
2. Update `lib/ai.ts`:
   ```ts
   import { createGoogleGenerativeAI } from "@ai-sdk/google"
   const google = createGoogleGenerativeAI({ apiKey: process.env.GOOGLE_GENERATIVE_AI_API_KEY })
   export const defaultModel = google("gemini-2.5-flash")
   export const analysisModel = google("gemini-2.5-pro")
   ```
3. Update `.env.example` with new key name
4. Test all 3 endpoints

### Phase 2: Editor Setup
1. Run `npx @tiptap/cli@latest add simple-editor`
2. Import `SimpleEditor` from `@/components/tiptap-templates/simple/simple-editor`
3. Style with Tailwind to match design system (4px radius, no shadows)

### Phase 3: Split-Panel UI
1. Refactor assistant page layout
2. Add `mode` state: `"chat" | "document"`
3. Conditional rendering based on mode
4. Smooth transition animations

### Phase 4: Agent Mode Detection
1. Update system prompt to classify intent
2. Parse mode from response metadata
3. Route content to chat or editor

### Phase 5: Document Persistence
1. Add Document model to Prisma schema
2. Create `/api/documents` endpoint
3. Auto-save editor content on changes
4. Link documents to queries

---

## Verification

- [ ] All API endpoints work with Gemini
- [ ] `/api/test-ai` returns response
- [ ] Chat mode renders full-width
- [ ] Document mode renders split-panel
- [ ] Editor formatting works (bold, lists, headings)
- [ ] Documents auto-save to database
- [ ] Styling matches design system (no shadows, 4px radius)

---

## Tasks Added to prd.json

42 atomic tasks appended to `plans/prd.json`:

| Phase | Count | Description |
|-------|-------|-------------|
| AI Provider Switch | 9 | SDK swap, config, env vars, testing |
| TipTap Editor Setup | 3 | Install, style, wrapper component |
| Database Schema | 3 | Document model, relation, migration |
| Document API | 5 | CRUD endpoints |
| Split-Panel UI | 5 | Mode state, components, layout (25/75 split) |
| Agent Mode Detection | 4 | Prompt update, parsing, routing, streaming |
| Document Persistence | 3 | Auto-save, database, query linking |
| Chat Panel UI | 4 | New thread, query display, actions, status |
| Editor Panel UI | 5 | Version dropdown, Sources, Export, Show edits |
| Versioning | 2 | Document versions, save prompt |

### Layout (from Harvey screenshot)

**Left Panel (25% width) - ChatPanel:**
- "New thread" button at top
- Query display with "Copy", "Save prompt", "Edit query" actions
- "Answering" status with "Generating new version..." progress
- Chat input at bottom

**Right Panel (75% width) - EditorPanel:**
- Header: "Draft" label + formatting toolbar
- Top-right: "Version 1" dropdown, "Sources", "Export" buttons
- "Show edits" toggle
- Document content area with TipTap editor

### Key Implementation Decisions

- **Mode signal:** AI prefixes response with `[MODE:document]` or `[MODE:chat]`
- **Editor:** Fully editable immediately after AI generation
- **Auto-save:** 2-3 second debounce after user stops typing
- **Models:** `gemini-2.5-flash` (default), `gemini-2.5-pro` (deep analysis)
- **Layout ratio:** 25% chat panel + 75% editor panel (not 1/3 + 2/3)
