[
  {
    "category": "ui",
    "description": "Add 'Draft Letter' action to recommender list row dropdown. Clicking triggers draft creation and switches parent state to workspace view.",
    "steps": [
      "In components/recommender/recommender-list.tsx, add 'Draft Letter' menu item to each recommender row's dropdown (next to Edit/Delete)",
      "Only show for recommenders with status confirmed or later",
      "On click, call POST /api/cases/[clientId]/drafts with { documentType: 'recommendation_letter', recommenderId: rec.id }",
      "If draft already exists (409), fetch existing draft via GET /api/cases/[clientId]/drafts filtering by recommenderId",
      "Call parent callback (e.g. onDraftLetter(draft, recommender)) to switch to workspace view"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Add 'Draft Letter' button to recommender detail sheet panel. Same behavior as list action.",
    "steps": [
      "In components/recommender/recommender-detail.tsx, add 'Draft Letter' button in the detail sheet header or actions area",
      "Only show for recommenders with status confirmed or later",
      "Same POST /api/cases/[clientId]/drafts logic as list action",
      "Call parent callback to switch to workspace view with draft + recommender data"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Create rec-letter-workspace.tsx -- the 3-panel layout component that replaces recommenders list inline.",
    "steps": [
      "Create components/recommender/rec-letter-workspace.tsx",
      "Props: draft (CaseDraft), recommender, clientId, onBack (returns to recommender list)",
      "Header row: back button ('Back to Recommenders'), title 'Drafting: {recommender.name}', status badge (draft.status)",
      "Body: flex layout with 3 panels -- w-1/4 (chat), w-2/4 (editor), w-1/4 (actions)",
      "Each panel independently scrollable (overflow-y-auto)",
      "Wire up state: editorContent (string), isStreaming (bool), messages (ephemeral chat array)"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Integrate workspace into recommenders tab. Toggle between recommender list and workspace based on parent state.",
    "steps": [
      "In app/(cases)/cases/[clientId]/page.tsx, add state: activeDraft + activeRecommender (null when showing list)",
      "In the recommenders tab section, conditionally render RecLetterWorkspace when activeDraft is set, else render existing recommender list/detail/form",
      "Pass onDraftLetter callback to RecommenderList and RecommenderDetail to set activeDraft state",
      "Pass onBack callback to RecLetterWorkspace to clear activeDraft state and return to list"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Create editor panel within workspace -- reuse DocumentEditor with streaming support and auto-save.",
    "steps": [
      "In rec-letter-workspace.tsx center panel, render DocumentEditor from components/editor/document-editor.tsx",
      "Pass content={editorContent}, isStreaming={isStreaming}, editable={!isStreaming}",
      "Implement auto-save with 2s debounce: on onChange, PATCH /api/cases/[clientId]/drafts/[id] with { content, plainText }",
      "Clone prose styling from existing draft workspace (app/(cases)/cases/[clientId]/drafts/[id]/page.tsx)",
      "Track dirty state to prevent save during streaming"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Create rec-letter-actions.tsx -- right panel with recommender context card, generate button, section list, version history, add-to-vault.",
    "steps": [
      "Create components/recommender/rec-letter-actions.tsx",
      "Props: draft, recommender, clientId, onGenerate, onRegenSection, sections, isStreaming, editorContent",
      "Top section: read-only recommender context card (name, title, org, relationship, criteriaRelevance tags, aiReasoning snippet)",
      "Render all sub-sections vertically with dividers"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Add 'Generate Full Letter' button to actions panel. Triggers fire-and-forget generation endpoint and polls for completion.",
    "steps": [
      "In rec-letter-actions.tsx, add 'Generate Full Letter' button below context card",
      "On click: POST /api/cases/[clientId]/drafts/[id]/generate (existing endpoint)",
      "Set isStreaming=true in parent, disable button during generation",
      "Poll GET /api/cases/[clientId]/drafts/[id] every 2s until status changes from 'generating' to 'draft'",
      "On completion: update editorContent with returned content, set isStreaming=false",
      "Handle error: show toast, revert status"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Add section list with per-section regenerate to actions panel.",
    "steps": [
      "In rec-letter-actions.tsx, render clickable section list from draft.sections array",
      "Each section: title + small regenerate icon button",
      "On regenerate click: show optional instruction input (small textarea + submit)",
      "Call POST /api/cases/[clientId]/drafts/[id]/regenerate with { sectionId, instruction }",
      "Poll for completion, update editor content on done",
      "Disable regenerate buttons during any active generation"
    ],
    "passes": false
  },
  {
    "category": "ui",
    "description": "Add version history controls to actions panel -- save version button + version list dropdown.",
    "steps": [
      "In rec-letter-actions.tsx, add 'Save Version' button with optional version note input",
      "On click: POST /api/cases/[clientId]/drafts/[id]/versions with { content: current editor content, versionNote }",
      "Fetch version list via GET /api/cases/[clientId]/drafts/[id]/versions",
      "Render as dropdown or collapsible list (timestamp + note)",
      "On version click: restore that version's content into editor (confirm dialog first)"
    ],
    "passes": false
  },
  {
    "category": "ui",
    "description": "Add 'Add to Vault' button to actions panel. Converts draft to PDF, uploads to vault, triggers processing.",
    "steps": [
      "In rec-letter-actions.tsx, add 'Add to Vault' button at bottom",
      "Disable when draft content is empty or status is 'not_started' or 'generating'",
      "On click: POST /api/cases/[clientId]/recommenders/[id]/add-to-vault",
      "Show loading state during upload",
      "On success: show toast with link to vault document, update recommender status badge",
      "On error: show error toast"
    ],
    "passes": false
  },
  {
    "category": "ui",
    "description": "Create rec-letter-chat.tsx -- left panel with ephemeral chat messages and input.",
    "steps": [
      "Create components/recommender/rec-letter-chat.tsx",
      "Props: messages (array), onSendMessage, isStreaming, clientId, recommenderId",
      "Message list: scrollable, auto-scroll to bottom on new messages",
      "Each message: role (user/assistant) with appropriate styling",
      "Input: textarea at bottom with send button, disabled during streaming",
      "Suggestion chips above input: 'Make more formal', 'Strengthen criteria sections', 'Add more specific examples'"
    ],
    "passes": false
  },
  {
    "category": "ui",
    "description": "Wire chat panel to API -- send messages, stream responses, update editor from AI edits.",
    "steps": [
      "In rec-letter-workspace.tsx, use useChat + DefaultChatTransport (from existing assistant/query pattern) to connect to draft-chat endpoint",
      "Configure DefaultChatTransport with POST /api/cases/[clientId]/recommenders/[id]/draft-chat, passing currentContent as extra body param",
      "Chat text streams automatically via useChat; editor updates arrive via tool calls (update_draft_section, update_full_draft) handled in onStepFinish callback",
      "Append assistant response to ephemeral messages array",
      "If AI returns editor update (update_draft_section or update_full_draft tool calls via onStepFinish), apply to editorContent",
      "Set isStreaming during response, clear on completion"
    ],
    "passes": false
  },
  {
    "category": "api",
    "description": "Create chat API route for rec-letter conversational agent at /api/cases/[clientId]/recommenders/[id]/draft-chat.",
    "steps": [
      "Create app/api/cases/[clientId]/recommenders/[id]/draft-chat/route.ts",
      "POST handler: parse body { messages: Message[], currentContent: string }",
      "Auth: use authorizeCaseAccess(clientId) pattern from existing draft routes",
      "Validate recommender belongs to client",
      "Invoke rec-letter-chat-agent via ToolLoopAgent, return createAgentUIStreamResponse (matches /api/assistant/query pattern)",
      "Return streaming response via createAgentUIStreamResponse"
    ],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Create rec-letter-chat-agent.ts -- conversational agent for iterative letter refinement via chat.",
    "steps": [
      "Create lib/drafting-agents/rec-letter-chat-agent.ts",
      "System prompt: EB-1A recommendation letter legal writing expert, conversational mode",
      "Use ToolLoopAgent class (not raw generateText) with streaming via createAgentUIStreamResponse",
      "Extend createDraftingTools(clientId) with additional tools",
      "Add get_current_draft tool: returns currentContent passed from request (no DB fetch needed)",
      "Add update_draft_section tool: takes { heading: string, newContent: string }, returns structured replacement",
      "Add update_full_draft tool: returns full document markdown replacement",
      "Use defaultModel (gemini-2.5-flash) for chat responses",
      "Accept messages array for conversation context, stream output"
    ],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Define streaming response format for chat agent -- separate chat text from editor operations in the stream.",
    "steps": [
      "Use AI SDK's ToolLoopAgent + createAgentUIStreamResponse as streaming protocol (no custom JSON lines needed)",
      "Chat text streams natively via AI SDK stream protocol to useChat on frontend",
      "Editor updates delivered as tool calls (update_draft_section, update_full_draft) -- frontend handles via onStepFinish callback",
      "Implement tool call handling in rec-letter-chat-agent.ts via ToolLoopAgent onStepFinish",
      "Frontend uses useChat + DefaultChatTransport to consume stream, no manual parsing needed"
    ],
    "passes": false
  },
  {
    "category": "api",
    "description": "Create add-to-vault API route at /api/cases/[clientId]/recommenders/[id]/add-to-vault.",
    "steps": [
      "Create app/api/cases/[clientId]/recommenders/[id]/add-to-vault/route.ts",
      "POST handler, no body needed",
      "Auth: authorizeCaseAccess(clientId), validate recommender belongs to client",
      "Fetch CaseDraft where clientId + documentType=recommendation_letter + recommenderId=id",
      "If no draft or empty content, return 400"
    ],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Implement HTML-to-PDF conversion for draft content in add-to-vault flow.",
    "steps": [
      "Install pdfkit as PDF generation library (add to package.json)",
      "Create lib/pdf-generator.ts utility using pdfkit",
      "Accept HTML string (from draft.content TipTap JSON -> HTML), return Buffer",
      "Style PDF to match professional recommendation letter format (letterhead-style, proper margins, fonts)",
      "Use in add-to-vault route to convert draft content to PDF buffer"
    ],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Complete add-to-vault flow: upload PDF to S3, create VaultDocument, trigger processing pipeline.",
    "steps": [
      "In add-to-vault route, after PDF generation:",
      "Upload PDF buffer to S3 with key: vaults/{vaultId}/{uuid}.pdf",
      "Get client's vault ID (client.vaultId or find via prisma)",
      "Create Document record: name='Recommendation Letter - {recommender.name}.pdf', fileType='application/pdf', storageKey, embeddingStatus='pending', vaultId",
      "Trigger processing: POST /api/vaults/{vaultId}/documents/process with { documentId }",
      "Update recommender status to 'letter_finalized' via prisma update",
      "Return created document metadata in response"
    ],
    "passes": false
  },
  {
    "category": "ui",
    "description": "Handle workspace open when draft is already in 'generating' state -- show loading/polling UI.",
    "steps": [
      "In rec-letter-workspace.tsx, check draft.status on mount",
      "If status is 'generating': set isStreaming=true, start polling GET /api/cases/[clientId]/drafts/[id] every 2s",
      "On poll completion (status changes to 'draft'): update editorContent, set isStreaming=false",
      "Show skeleton or spinner overlay on editor during generation"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Handle empty draft state in workspace -- show helpful empty state in editor and disable vault button.",
    "steps": [
      "In editor panel: if draft content is empty, show placeholder text 'Click Generate Full Letter to get started'",
      "Disable 'Add to Vault' button with tooltip 'Generate a letter first' when content is empty",
      "Disable section list and regenerate when no sections exist"
    ],
    "passes": true
  },
  {
    "category": "ui",
    "description": "Add suggestion chips to chat panel for common refinement actions.",
    "steps": [
      "In rec-letter-chat.tsx, render chip buttons above the input textarea",
      "Chips: 'Make more formal', 'Strengthen [criterion] section' (dynamic per recommender criteria), 'Add more specific examples', 'Shorten letter'",
      "On chip click: populate input with chip text and auto-send",
      "Hide chips after first message exchange (they're just conversation starters)"
    ],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Ensure recommendation-letter agent in generate endpoint passes recommenderId correctly.",
    "steps": [
      "In app/api/cases/[clientId]/drafts/[id]/generate/route.ts, verify that when documentType is recommendation_letter, recommenderId from the draft is passed to the agent",
      "Check lib/drafting-agents/recommendation-letter.ts accepts and uses recommenderId param",
      "Verify get_recommender tool is called with correct ID during generation"
    ],
    "passes": false
  },
  {
    "category": "ui",
    "description": "Version restore: replace editor content with selected version without clearing chat messages.",
    "steps": [
      "In version history dropdown click handler, show confirmation dialog",
      "On confirm: set editorContent to selected version's content",
      "Do NOT clear messages array (chat is independent of version state)",
      "Auto-save the restored content via the standard debounced PATCH"
    ],
    "passes": false
  },
  {
    "category": "functional",
    "description": "Cap chat messages at 20. Truncate oldest user/assistant pairs beyond limit before sending to draft-chat API.",
    "steps": [
      "In rec-letter-workspace.tsx (or useChat config), before sending messages to API, truncate to most recent 20 messages",
      "Always keep the system message (if any) and drop oldest user/assistant pairs first",
      "Apply truncation client-side before POST to /api/cases/[clientId]/recommenders/[id]/draft-chat",
      "Also enforce server-side: in draft-chat route.ts, slice messages to last 20 if exceeding limit"
    ],
    "passes": false
  }
]
