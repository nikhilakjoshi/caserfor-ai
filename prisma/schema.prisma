// schema.prisma
// Standalone Legal AI Platform - Single Tenant

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum VaultType {
  knowledge_base
  sandbox
}

enum EmbeddingStatus {
  pending
  processing
  completed
  failed
}

enum WorkflowOutputType {
  draft
  review_table
  extraction
  transformation
}

enum WorkflowStepAction {
  input
  process
  review
  output
}

enum OwnerType {
  system
  personal
}

enum QueryOutputType {
  chat
  draft
  review_table
  analysis
}

enum QueryStatus {
  pending
  streaming
  completed
  failed
}

enum SourceType {
  vault
  document
  agent
  external_database
  system_knowledge
}

enum StarredItemType {
  prompt
  example
}

enum UserRole {
  applicant
  lawyer
  admin
}

enum IntakeStatus {
  draft
  submitted
  under_review
  reviewed
  paid
}

enum EligibilityVerdict {
  strong
  moderate
  weak
  insufficient
}

enum RecommenderStatus {
  suggested
  identified
  contacted
  confirmed
  letter_drafted
  letter_finalized
}

enum RecommenderSourceType {
  manual
  ai_suggested
  linkedin_extract
}

enum DraftDocumentType {
  petition_letter
  personal_statement
  recommendation_letter
  cover_letter
  exhibit_list
  table_of_contents
  rfe_response
}

enum DraftStatus {
  not_started
  generating
  draft
  in_review
  final
}

// ============================================
// MODELS
// ============================================

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  name         String
  passwordHash String?
  role         UserRole @default(applicant)
  avatarUrl    String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  queries         AssistantQuery[]
  prompts         Prompt[]
  starredItems    StarredItem[]
  historyEntries  HistoryEntry[]
  agents          Agent[]
  caseAssignments CaseAssignment[]

  @@map("users")
}

model CaseAssignment {
  id         String   @id @default(cuid())
  lawyerId   String
  clientId   String
  assignedAt DateTime @default(now())

  // Relations
  lawyer User   @relation(fields: [lawyerId], references: [id], onDelete: Cascade)
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([lawyerId, clientId])
  @@index([lawyerId])
  @@index([clientId])
  @@map("case_assignments")
}

model Vault {
  id          String    @id @default(cuid())
  name        String
  description String?
  type        VaultType @default(knowledge_base)
  isShared    Boolean   @default(false)
  maxFiles    Int       @default(100000)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  documents Document[]
  client    Client?

  @@map("vaults")
}

model Document {
  id              String          @id @default(cuid())
  vaultId         String
  name            String
  documentType    String?
  fileType        String
  storageKey      String
  sizeBytes       Int
  pageCount       Int?
  metadata        Json            @default("{}")
  embeddingStatus EmbeddingStatus @default(pending)
  chunkCount      Int?
  embeddedAt      DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  vault Vault @relation(fields: [vaultId], references: [id], onDelete: Cascade)

  @@index([vaultId])
  @@index([documentType])
  @@index([embeddingStatus])
  @@map("documents")
}

model Workflow {
  id             String             @id @default(cuid())
  name           String
  description    String
  category       String
  outputType     WorkflowOutputType
  stepCount      Int?
  columnSchema   Json?
  promptTemplate String             @db.Text
  isSystem       Boolean            @default(false)
  isActive       Boolean            @default(true)
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt

  // Relations
  steps WorkflowStep[]

  @@index([category])
  @@index([isSystem])
  @@map("workflows")
}

model WorkflowStep {
  id         String             @id @default(cuid())
  workflowId String
  order      Int
  name       String
  action     WorkflowStepAction
  config     Json               @default("{}")

  // Relations
  workflow Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([workflowId])
  @@map("workflow_steps")
}

model Prompt {
  id        String    @id @default(cuid())
  userId    String?
  name      String
  content   String    @db.Text
  ownerType OwnerType
  category  String?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([ownerType])
  @@map("prompts")
}

model Example {
  id          String    @id @default(cuid())
  name        String
  promptText  String    @db.Text
  documentRef String?
  response    String    @db.Text
  ownerType   OwnerType
  createdAt   DateTime  @default(now())

  @@map("examples")
}

model AssistantQuery {
  id             String          @id @default(cuid())
  userId         String
  conversationId String?
  inputText      String          @db.Text
  outputText     String?         @db.Text
  outputType     QueryOutputType @default(chat)
  deepAnalysis   Boolean         @default(false)
  tokenCount     Int?
  latencyMs      Int?
  status         QueryStatus     @default(pending)
  createdAt      DateTime        @default(now())

  // Relations
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  sources        SourceReference[]
  historyEntry   HistoryEntry?
  editorDocument EditorDocument?

  @@index([userId])
  @@index([conversationId])
  @@index([createdAt])
  @@map("assistant_queries")
}

model SourceReference {
  id         String     @id @default(cuid())
  queryId    String
  sourceType SourceType
  sourceId   String
  sourceName String

  // Relations
  query AssistantQuery @relation(fields: [queryId], references: [id], onDelete: Cascade)

  @@index([queryId])
  @@map("source_references")
}

model HistoryEntry {
  id             String   @id @default(cuid())
  userId         String
  queryId        String   @unique
  title          String
  type           String
  sourcesSummary String?
  createdAt      DateTime @default(now())

  // Relations
  user  User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  query AssistantQuery @relation(fields: [queryId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("history_entries")
}

model StarredItem {
  id        String          @id @default(cuid())
  userId    String
  itemType  StarredItemType
  itemId    String
  createdAt DateTime        @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, itemType, itemId])
  @@index([userId])
  @@map("starred_items")
}

model Agent {
  id          String   @id @default(cuid())
  userId      String
  name        String
  slug        String
  description String?
  instruction String   @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, slug])
  @@index([userId])
  @@map("agents")
}

model EditorDocument {
  id             String   @id @default(cuid())
  title          String
  content        Json
  queryId        String   @unique
  currentVersion Int      @default(1)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  query    AssistantQuery    @relation(fields: [queryId], references: [id], onDelete: Cascade)
  versions DocumentVersion[]

  @@index([queryId])
  @@map("editor_documents")
}

model DocumentVersion {
  id         String   @id @default(cuid())
  documentId String
  version    Int
  content    Json
  createdAt  DateTime @default(now())

  // Relations
  document EditorDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@unique([documentId, version])
  @@index([documentId])
  @@map("document_versions")
}

model Client {
  id                       String            @id @default(cuid())
  userId                   String
  firstName                String?
  lastName                 String?
  email                    String?
  phone                    String?
  dateOfBirth              DateTime?
  citizenship              String?
  fieldOfExpertise         String?
  education                Json?
  currentEmployer          String?
  usIntentType             String?
  usIntentDetails          String?
  hasMajorAchievement      Boolean?
  majorAchievementDetails  String?           @db.Text
  socialFollowing          String?
  keynotes                 String?           @db.Text
  recommenderNotes         Json?
  selfAssessment           String?           @db.Text
  standingLevel            String?
  recognitionScope         String?
  evidenceChecklist        Json?
  urgency                  String?
  idealTimeline            String?
  priorConsultations       String?           @db.Text
  altCategories            Json?
  consentToProcess         Boolean?
  currentImmigrationStatus String?
  desiredStatus            String?
  previousApplications     String?           @db.Text
  urgencyReason            String?           @db.Text
  specialCircumstances     String?           @db.Text
  communicationPreference  String?
  timezone                 String?
  currentStep              Int               @default(1)
  status                   IntakeStatus      @default(draft)
  vaultId                  String?           @unique
  stripeSessionId          String?
  stripeCustomerId         String?
  paidAt                   DateTime?
  createdAt                DateTime          @default(now())
  updatedAt                DateTime          @updatedAt

  // Relations
  vault              Vault?              @relation(fields: [vaultId], references: [id])
  criterionResponses CriterionResponse[]
  eligibilityReport  EligibilityReport?
  gapAnalyses        GapAnalysis[]
  caseAssignments    CaseAssignment[]
  recommenders       Recommender[]
  caseDrafts         CaseDraft[]

  @@index([userId])
  @@index([status])
  @@map("clients")
}

model CriterionResponse {
  id        String   @id @default(cuid())
  clientId  String
  criterion String
  responses Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([clientId, criterion])
  @@index([clientId])
  @@map("criterion_responses")
}

model EligibilityReport {
  id        String              @id @default(cuid())
  clientId  String              @unique
  verdict   EligibilityVerdict
  summary   String              @db.Text
  criteria  Json
  rawOutput String?             @db.Text
  createdAt DateTime            @default(now())

  // Relations
  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("eligibility_reports")
}

model GapAnalysis {
  id              String   @id @default(cuid())
  clientId        String
  overallStrength String
  summary         String   @db.Text
  criteria        Json
  priorityActions Json
  rawOutput       String?  @db.Text
  createdAt       DateTime @default(now())

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@map("gap_analyses")
}

model Recommender {
  id                String                @id @default(cuid())
  clientId          String
  name              String
  title             String?
  organization      String?
  relationship      String?
  linkedinUrl       String?
  email             String?
  phone             String?
  notes             String?               @db.Text
  status            RecommenderStatus     @default(suggested)
  sourceType        RecommenderSourceType @default(manual)
  aiReasoning       String?               @db.Text
  criteriaRelevance String[]
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  // Relations
  client      Client                  @relation(fields: [clientId], references: [id], onDelete: Cascade)
  attachments RecommenderAttachment[]
  caseDrafts  CaseDraft[]

  @@index([clientId])
  @@map("recommenders")
}

model RecommenderAttachment {
  id            String   @id @default(cuid())
  recommenderId String
  name          String
  fileType      String
  storageKey    String
  createdAt     DateTime @default(now())

  // Relations
  recommender Recommender @relation(fields: [recommenderId], references: [id], onDelete: Cascade)

  @@index([recommenderId])
  @@map("recommender_attachments")
}

model CaseDraft {
  id            String            @id @default(cuid())
  clientId      String
  documentType  DraftDocumentType
  title         String?
  content       Json?
  plainText     String?           @db.Text
  sections      Json?
  status        DraftStatus       @default(not_started)
  recommenderId String?
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt

  // Relations
  client      Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)
  recommender Recommender?       @relation(fields: [recommenderId], references: [id])
  versions    CaseDraftVersion[]

  @@index([clientId])
  @@index([clientId, documentType])
  @@unique([clientId, documentType, recommenderId])
  @@map("case_drafts")
}

model CaseDraftVersion {
  id          String   @id @default(cuid())
  draftId     String
  content     Json
  plainText   String?  @db.Text
  sections    Json?
  versionNote String?
  createdBy   String?
  createdAt   DateTime @default(now())

  // Relations
  draft CaseDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@index([draftId])
  @@map("case_draft_versions")
}
